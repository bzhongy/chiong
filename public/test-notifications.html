<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification System Test - Chiong.fi</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Ethers.js (for testing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.6.9/ethers.umd.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Notification System Test</h1>
        <p class="text-muted">This page tests the improvements to the transaction notification system.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Test Scenarios</h3>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="testBasicNotifications()">
                        Test Basic Notifications
                    </button>
                    <button class="btn btn-warning" onclick="testPendingNotifications()">
                        Test Pending Notifications (Stuck)
                    </button>
                    <button class="btn btn-success" onclick="testRobustStatusChecker()">
                        Test Robust Status Checker
                    </button>
                    <button class="btn btn-danger" onclick="testClearAllFunction()">
                        Test Clear All Function
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <h3>Manual Controls</h3>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" onclick="clearAllNotifications()">
                        Clear All Notifications
                    </button>
                    <button class="btn btn-outline-secondary" onclick="showNotificationCount()">
                        Show Active Notification Count
                    </button>
                    <button class="btn btn-outline-info" onclick="testDifferentStatusFormats()">
                        Test Different Status Formats
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-5">
            <h3>Test Results</h3>
            <div id="test-results" class="alert alert-info">
                Run tests to see results here...
            </div>
        </div>
    </div>

    <!-- Include ABIs (mock minimal versions) -->
    <script>
        // Mock minimal ABIs for testing
        window.OPTION_BOOK_ABI = [];
        window.ERC20ABI = [];
        
        // Mock ethers provider for testing
        window.ethersProvider = {
            getTransactionReceipt: async (hash) => {
                // Simulate different response types
                const responses = {
                    '0x1111111111111111111111111111111111111111111111111111111111111111': { status: 1 },
                    '0x2222222222222222222222222222222222222222222222222222222222222222': { status: '0x1' },
                    '0x3333333333333333333333333333333333333333333333333333333333333333': { status: true },
                    '0x4444444444444444444444444444444444444444444444444444444444444444': { status: 0 },
                    '0x5555555555555555555555555555555555555555555555555555555555555555': { status: '0x0' },
                    '0x6666666666666666666666666666666666666666666666666666666666666666': { status: false },
                    '0x7777777777777777777777777777777777777777777777777777777777777777': { status: 'success' },
                    '0x8888888888888888888888888888888888888888888888888888888888888888': { status: 'failed' },
                    '0x9999999999999999999999999999999999999999999999999999999999999999': { status: 'unknown_format' }
                };
                
                return responses[hash] || { status: 1 };
            }
        };
    </script>
    
    <!-- Include notification system -->
    <script src="tx-notifications.js"></script>
    
    <script>
        // Initialize the notification system
        window.txNotifications.initializeTransactionNotifications();
        
        function testBasicNotifications() {
            logResult('Testing basic notifications...');
            
            // Test approval notification
            const approveHash = '0x1111111111111111111111111111111111111111111111111111111111111111';
            window.txNotifications.trackTransaction(
                approveHash,
                'approve',
                ['0x123...', ethers.constants.MaxUint256],
                '0xd9aAEc86B65D86f6A7B5B1b0c42FFA531710b6CA'
            );
            
            // Test fillOrder notification
            const fillOrderHash = '0x2222222222222222222222222222222222222222222222222222222222222222';
            window.txNotifications.trackTransaction(
                fillOrderHash,
                'fillOrder',
                [{
                    isCall: true,
                    strikes: [ethers.BigNumber.from('240000000000')],
                    expiry: Math.floor(Date.now() / 1000) + 86400,
                    collateral: '0xd9aAec86B65D86f6A7B5B1b0c42FFA531710b6CA'
                }],
                '0x123...abc'
            );
            
            logResult('✅ Two notifications created (approve + fillOrder)');
        }
        
        function testPendingNotifications() {
            logResult('Testing pending notifications that might get stuck...');
            
            // Create several pending notifications
            const hashes = [
                '0x3333333333333333333333333333333333333333333333333333333333333333',
                '0x4444444444444444444444444444444444444444444444444444444444444444',
                '0x5555555555555555555555555555555555555555555555555555555555555555'
            ];
            
            hashes.forEach((hash, index) => {
                window.txNotifications.trackTransaction(
                    hash,
                    'approve',
                    ['0x456...', ethers.BigNumber.from('1000000')],
                    '0x4200000000000000000000000000000000000006'
                );
            });
            
            logResult('⏳ Three pending notifications created (these would normally get stuck)');
        }
        
        async function testRobustStatusChecker() {
            logResult('Testing robust status checker with different formats...');
            
            const testCases = [
                { hash: '0x1111111111111111111111111111111111111111111111111111111111111111', expected: 'SUCCESS' },
                { hash: '0x2222222222222222222222222222222222222222222222222222222222222222', expected: 'SUCCESS' },
                { hash: '0x3333333333333333333333333333333333333333333333333333333333333333', expected: 'SUCCESS' },
                { hash: '0x4444444444444444444444444444444444444444444444444444444444444444', expected: 'FAILED' },
                { hash: '0x5555555555555555555555555555555555555555555555555555555555555555', expected: 'FAILED' },
                { hash: '0x6666666666666666666666666666666666666666666666666666666666666666', expected: 'FAILED' },
                { hash: '0x7777777777777777777777777777777777777777777777777777777777777777', expected: 'SUCCESS' },
                { hash: '0x8888888888888888888888888888888888888888888888888888888888888888', expected: 'FAILED' },
                { hash: '0x9999999999999999999999999999999999999999999999999999999999999999', expected: 'SUCCESS (default)' }
            ];
            
            for (const testCase of testCases) {
                const receipt = await window.ethersProvider.getTransactionReceipt(testCase.hash);
                const isSuccess = window.txNotifications.isTransactionSuccessful(receipt);
                const result = isSuccess ? 'SUCCESS' : 'FAILED';
                
                logResult(`📊 Hash ${testCase.hash.substring(0, 10)}...: ${result} (expected: ${testCase.expected})`);
                
                // Track and update this transaction to see the result
                window.txNotifications.trackTransaction(testCase.hash, 'approve', [], '0x123');
                setTimeout(() => {
                    window.txNotifications.updateTransactionStatus(
                        testCase.hash, 
                        isSuccess ? window.txNotifications.TX_STATUS.CONFIRMED : window.txNotifications.TX_STATUS.FAILED,
                        receipt
                    );
                }, 500);
            }
        }
        
        function testClearAllFunction() {
            logResult('Testing clear all function...');
            
            // First create some notifications
            testBasicNotifications();
            testPendingNotifications();
            
            setTimeout(() => {
                logResult('📊 Before clear: ' + getActiveNotificationCount() + ' active notifications');
                
                // Clear all
                window.txNotifications.clearAllNotifications();
                
                setTimeout(() => {
                    logResult('🧹 After clear: ' + getActiveNotificationCount() + ' active notifications');
                    logResult('✅ Clear all function test complete');
                }, 500);
            }, 1000);
        }
        
        function testDifferentStatusFormats() {
            logResult('Testing different status formats from various RPCs...');
            
            const statusFormats = [
                { status: 1, desc: 'Number 1' },
                { status: '0x1', desc: 'Hex string 0x1' },
                { status: true, desc: 'Boolean true' },
                { status: 'success', desc: 'String success' },
                { status: 0, desc: 'Number 0' },
                { status: '0x0', desc: 'Hex string 0x0' },
                { status: false, desc: 'Boolean false' },
                { status: 'failed', desc: 'String failed' },
                { status: 'weird_format', desc: 'Unknown format' },
                { status: null, desc: 'Null status' }
            ];
            
            statusFormats.forEach((format, index) => {
                const mockReceipt = { status: format.status };
                const isSuccess = window.txNotifications.isTransactionSuccessful(mockReceipt);
                const result = isSuccess ? '✅ SUCCESS' : '❌ FAILED';
                
                logResult(`${format.desc}: ${result} (status: ${JSON.stringify(format.status)})`);
            });
        }
        
        function showNotificationCount() {
            const count = getActiveNotificationCount();
            logResult(`📊 Currently ${count} active notifications`);
        }
        
        function getActiveNotificationCount() {
            const container = document.getElementById('tx-notification-container');
            if (!container) return 0;
            
            const notifications = container.querySelectorAll('.tx-notification');
            return notifications.length;
        }
        
        function logResult(message) {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(message);
        }
        
        // Initial message
        logResult('🚀 Notification system test page loaded. Ready for testing!');
        logResult('💡 Tip: Open browser console to see detailed logs');
    </script>
</body>
</html> 